<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

    <head>
        <title>Retiro de Efectivo</title>
        <link rel="stylesheet" th:href="@{/css/StyleRetiro.css}">
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    </head>

    <body layout:fragment="body">

        <div class="atm-withdrawal-background">
            <div class="container h-100 py-4">

                <div class="row mb-4 fade-in-down">
                    <div class="col-12 d-flex justify-content-between align-items-center header-panel">
                        <div>
                            <h5 class="text-white-50 m-0">Hola, <span class="text-white fw-bold" th:text="${UsuarioLogueado}">Usuario</span></h5>
                            <small class="text-info"><i class="fa-solid fa-server me-1"></i> Cajero #<span th:text="${idCajero}">001</span></small>
                        </div>

                        <div class="balance-mini-display" th:if="${saldoUsuario != null}">
                            <small>SALDO DISPONIBLE</small>
                            <div class="amount text-success">$ <span th:text="${#numbers.formatDecimal(saldoUsuario.saldo, 1, 'COMMA', 2, 'POINT')}">0.00</span></div>
                        </div>
                    </div>
                </div>

                <div class="row justify-content-center mb-3" th:if="${mensajeError}">
                    <div class="col-md-8">
                        <div class="alert alert-danger custom-alert animate-shake text-center">
                            <i class="fa-solid fa-circle-xmark me-2"></i> <strong th:text="${mensajeError}">Error</strong>
                        </div>
                    </div>
                </div>

                <div class="row g-4 main-interface" th:if="${ListaDesglose == null}">

                    <div class="col-lg-3 col-md-4 order-2 order-md-1 d-flex flex-column gap-3 justify-content-center align-items-center fade-in-left">
                        <div class="section-label">MONEDAS</div>
                        <button type="button" class="btn-coin" onclick="addAmount(0.50)">$0.50</button>
                        <button type="button" class="btn-coin" onclick="addAmount(1.00)">$1.00</button>
                        <button type="button" class="btn-coin" onclick="addAmount(2.00)">$2.00</button>
                        <button type="button" class="btn-coin" onclick="addAmount(5.00)">$5.00</button>
                        <button type="button" class="btn-coin" onclick="addAmount(10.00)">$10.00</button>
                    </div>

                    <div class="col-lg-6 col-md-4 order-1 order-md-2 fade-in-up">
                        <div class="center-console">

                            <form th:action="@{/cajeros/retirar}" method="post" id="withdrawForm">
                                <div class="screen-display mb-4">
                                    <label class="screen-label">MONTO A RETIRAR</label>
                                    <div class="input-wrapper">
                                        <span class="currency-sign">$</span>
                                        <input type="number" step="0.50" name="monto" id="inputMonto" class="screen-input" placeholder="0.00" required readonly>
                                    </div>
                                    <small class="text-white-50">Seleccione una opción rápida o use el teclado</small>
                                </div>

                                <div class="keypad-grid">
                                    <button type="button" class="key-btn" onclick="pressKey('1')">1</button>
                                    <button type="button" class="key-btn" onclick="pressKey('2')">2</button>
                                    <button type="button" class="key-btn" onclick="pressKey('3')">3</button>
                                    <button type="button" class="key-btn" onclick="pressKey('4')">4</button>
                                    <button type="button" class="key-btn" onclick="pressKey('5')">5</button>
                                    <button type="button" class="key-btn" onclick="pressKey('6')">6</button>
                                    <button type="button" class="key-btn" onclick="pressKey('7')">7</button>
                                    <button type="button" class="key-btn" onclick="pressKey('8')">8</button>
                                    <button type="button" class="key-btn" onclick="pressKey('9')">9</button>

                                    <button type="button" class="key-btn action-clear" onclick="clearInput()">C</button>
                                    <button type="button" class="key-btn" onclick="pressKey('0')">0</button>
                                    <button type="button" class="key-btn action-dot" onclick="pressDot()">.</button>
                                </div>

                                <div class="actions-grid mt-4">
                                    <a th:href="@{|/cajeros/${idCajero}|}" class="btn btn-outline-secondary w-100 mb-4">CANCELAR</a>
                                    <button type="submit" class="btn btn-success w-100 btn-withdraw">RETIRAR</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-4 order-3 order-md-3 d-flex flex-column gap-3 justify-content-center align-items-center fade-in-right">
                        <div class="section-label">BILLETES</div>
                        <button type="button" class="btn-bill" onclick="addAmount(20)">$20</button>
                        <button type="button" class="btn-bill" onclick="addAmount(50)">$50</button>
                        <button type="button" class="btn-bill" onclick="addAmount(100)">$100</button>
                        <button type="button" class="btn-bill" onclick="addAmount(200)">$200</button>
                        <button type="button" class="btn-bill" onclick="addAmount(500)">$500</button>
                        <button type="button" class="btn-bill" onclick="addAmount(1000)">$1000</button>
                    </div>
                </div>

                <div class="row justify-content-center fade-in-up" th:if="${ListaDesglose != null}">
                    <div class="col-md-8 col-lg-6">
                        <div class="success-ticket">
                            <div class="ticket-header">
                                <i class="fa-regular fa-circle-check fa-4x text-success mb-3"></i>
                                <h3 class="text-success" th:text="${mensajeExito}">Retiro Exitoso</h3>
                                <p class="text-white-50">Por favor, tome su efectivo</p>
                            </div>

                            <div class="ticket-body">
                                <h5 class="border-bottom border-secondary pb-2 mb-3 text-white">Desglose de Efectivo</h5>

                                <div class="desglose-list">
                                    <div class="desglose-item d-flex justify-content-between align-items-center mb-2" 
                                         th:each="item : ${ListaDesglose}">

                                        <div class="d-flex align-items-center">
                                            <i class="fa-solid fa-money-bill-1-wave me-3 text-info" th:if="${item.valor >= 20}"></i>
                                            <i class="fa-solid fa-coins me-3 text-warning" th:if="${item.valor < 20}"></i>

                                            <span class="text-white">
                                                <span th:text="${item.cantidad}">1</span> x 
                                                $<span th:text="${#numbers.formatDecimal(item.valor, 1, 'COMMA', 2, 'POINT')}">500.00</span>
                                            </span>
                                        </div>
                                        <span class="fw-bold text-white">
                                            $<span th:text="${#numbers.formatDecimal(item.valor * item.cantidad, 1, 'COMMA', 2, 'POINT')}">500.00</span>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="ticket-footer mt-4">
                                <a th:href="@{/cajeros/menu}" class="btn btn-primary w-100 py-3">
                                    <i class="fa-solid fa-house me-2"></i> VOLVER AL MENÚ
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <script>

            // Variable global para almacenar el valor actual
            let currentAmount = "";

            $(document).ready(function () {
                // Al cargar, asegurarnos que el input esté limpio
                updateScreen();
            });

            // Función cuando se presiona un número del teclado
            function pressKey(num) {
                // Evitar ceros a la izquierda innecesarios
                if (currentAmount === "0")
                    currentAmount = "";

                // Limite visual (opcional) para que no rompa el diseño
                if (currentAmount.length > 8)
                    return;

                currentAmount += num;
                updateScreen();
            }

            // Función para el botón de punto decimal
            function pressDot() {
                if (!currentAmount.includes(".")) {
                    if (currentAmount === "")
                        currentAmount = "0";
                    currentAmount += ".";
                    updateScreen();
                }
            }

            // Función para limpiar
            function clearInput() {
                currentAmount = "";
                updateScreen();
            }

            // Función para los botones rápidos (Monedas y Billetes)
            function addAmount(value) {
                // Convertimos a string y forzamos decimales si es necesario
                currentAmount = value.toString();
                updateScreen();
            }

            // Actualizar el input visual
            function updateScreen() {
                $('#inputMonto').val(currentAmount);

                // Habilitar/Deshabilitar botón de retiro
                const btn = $('.btn-withdraw');
                if (currentAmount === "" || parseFloat(currentAmount) === 0) {
                    btn.prop('disabled', true);
                    btn.addClass('btn-secondary').removeClass('btn-success');
                } else {
                    btn.prop('disabled', false);
                    btn.removeClass('btn-secondary').addClass('btn-success');
                }
            }

            // Intercepción del Submit para validación final básica
            $('#withdrawForm').on('submit', function (e) {
                if (currentAmount === "" || parseFloat(currentAmount) <= 0) {
                    e.preventDefault();
                    alert("Por favor ingrese un monto válido");
                }
                // El input 'monto' ya tiene el valor correcto gracias a updateScreen
            });

        </script>

    </body>
</html>